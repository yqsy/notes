---
title: 网络管理
date: 2017-10-23 14:26:38
categories: [linux, 系统管理]
---

<!-- TOC -->

- [1. 网络配置文件](#1-网络配置文件)
    - [1.1. Red Hat Linux](#11-red-hat-linux)
        - [1.1.1. /etc/sysconfig/network-scripts/ifcfg-eth0](#111-etcsysconfignetwork-scriptsifcfg-eth0)
        - [1.1.2. /etc/sysconfig/network-scripts/ifcfg-lo](#112-etcsysconfignetwork-scriptsifcfg-lo)
        - [1.1.3. /etc/sysconfig/network](#113-etcsysconfignetwork)
        - [1.1.4. /etc/resolv.conf](#114-etcresolvconf)
        - [1.1.5. 指令](#115-指令)
        - [1.1.6. 案例](#116-案例)
            - [1.1.6.1. 一块网卡绑定多个ip地址](#1161-一块网卡绑定多个ip地址)
    - [1.2. Debain/Ubuntu Linux](#12-debainubuntu-linux)
        - [1.2.1. /etc/network/interfaces](#121-etcnetworkinterfaces)
        - [1.2.2. 指令](#122-指令)
    - [1.3. openwrt](#13-openwrt)
        - [1.3.1. 参考资料](#131-参考资料)
        - [1.3.2. 设置静态dns](#132-设置静态dns)
- [2. 开启Linux代理转发功能](#2-开启linux代理转发功能)
- [3. 路由的配置](#3-路由的配置)
    - [3.1. route命令各项说明](#31-route命令各项说明)
- [4. 案例](#4-案例)
    - [4.1. 公司Linux路由器的架设](#41-公司linux路由器的架设)
- [5. 指令](#5-指令)

<!-- /TOC -->
<a id="markdown-1-网络配置文件" name="1-网络配置文件"></a>
# 1. 网络配置文件
<a id="markdown-11-red-hat-linux" name="11-red-hat-linux"></a>
## 1.1. Red Hat Linux
文件|说明
-|-
/etc/sysconfig/network-scripts/ifcfg-eth0|IP地址,子网掩码配置文件
/etc/sysconfig/network-scripts/ifcfg-lo|loopback,网卡回环地址
/etc/sysconfig/network|主机名和网关配置文件
/etc/resolv.conf|DNS配置文件
/etc/hosts|主机和IP的绑定信息

<a id="markdown-111-etcsysconfignetwork-scriptsifcfg-eth0" name="111-etcsysconfignetwork-scriptsifcfg-eth0"></a>
### 1.1.1. /etc/sysconfig/network-scripts/ifcfg-eth0
10.243.140.93
```
HWADDR=00:50:56:8a:16:27 # MAC地址
NAME=eth2
GATEWAY=10.243.141.254 # 网关
DNS1=10.253.47.200
DNS2=168.162.128.165
DOMAIN=internal.sungard.corp
DEVICE=eth2 # 网卡设备的名字
ONBOOT=yes # 开机启动网卡设备
USERCTL=no
BOOTPROTO=static # 静态的IP地址,如果网络环境为动态获取IP地址,此项值为dncp
NETMASK=255.255.254.0 # 子网掩码
IPADDR=10.243.140.93 #静态IP地址
PEERDNS=no

check_link_down() {
return 1;
}
```

<a id="markdown-112-etcsysconfignetwork-scriptsifcfg-lo" name="112-etcsysconfignetwork-scriptsifcfg-lo"></a>
### 1.1.2. /etc/sysconfig/network-scripts/ifcfg-lo
10.243.140.93
```
DEVICE=lo # 设备名
IPADDR=127.0.0.1 # IP地址
NETMASK=255.0.0.0 # 子网掩码
NETWORK=127.0.0.0 # 网络号
# If you're having problems with gated making 127.0.0.0/8 a martian,
# you can change this to something else (255.255.255.255, for example)
BROADCAST=127.255.255.255 # 广播地址
ONBOOT=yes # 开机启动
NAME=loopback # 本地回环地址
```

<a id="markdown-113-etcsysconfignetwork" name="113-etcsysconfignetwork"></a>
### 1.1.3. /etc/sysconfig/network
10.243.140.93
```
NETWORKING=yes # 网络配置是否正常运行
HOSTNAME=AP-SHA-KS-FIXLinux # Linux的主机名
```

<a id="markdown-114-etcresolvconf" name="114-etcresolvconf"></a>
### 1.1.4. /etc/resolv.conf
10.243.140.93
```
# Generated by NetworkManager
search internal.sungard.corp
nameserver 10.253.47.200
nameserver 168.162.128.165
```

<a id="markdown-115-指令" name="115-指令"></a>
### 1.1.5. 指令
```
# 重启网络服务
service network restart
```

<a id="markdown-116-案例" name="116-案例"></a>
### 1.1.6. 案例
<a id="markdown-1161-一块网卡绑定多个ip地址" name="1161-一块网卡绑定多个ip地址"></a>
#### 1.1.6.1. 一块网卡绑定多个ip地址
(没试过)
```
# 添加/etc/sysconfig/network-scripts/ifcfg-eth0:0
DEVICE="eth0:0"
BOOTPROTO=static
IPADDR="192.168.66.168"
NETMASK="255.255.255.0"
ONBOOT="yse"
NETWORK=192.168.60.0
BROADCAST=192.168.60.255
```
```
service network restart
```


<a id="markdown-12-debainubuntu-linux" name="12-debainubuntu-linux"></a>
## 1.2. Debain/Ubuntu Linux
文件|说明
-|-
/etc/network/interfaces|IP地址,子网掩码等配置文件
/etc/resolv.conf|DNs配置文件
/etc/hostname|全局主机名配置文件
/etc/networks|设置网络号相关信息
/etc/hosts|设置主机和IP绑定信息

<a id="markdown-121-etcnetworkinterfaces" name="121-etcnetworkinterfaces"></a>
### 1.2.1. /etc/network/interfaces
```
auto lo eth1 # 自动加载
iface lo inet loopback # 回环
iface eth1 inet dncp 
iface eth0 inet static
    address 192.168.60.188
    network 192.168.60.0
    netmask 255.255.255.0
    broadcast 192.168.60.255
    gateway 192.168.60.1
```

<a id="markdown-122-指令" name="122-指令"></a>
### 1.2.2. 指令
```
# 重启网络服务
sudo /etc/init.d/networking restart
```

<a id="markdown-13-openwrt" name="13-openwrt"></a>
## 1.3. openwrt
文件|说明
-|-
/etc/config/network|switch VLANS
/etc/config/dhcp|dhcpd dnsmasq

<a id="markdown-131-参考资料" name="131-参考资料"></a>
### 1.3.1. 参考资料
* https://wiki.openwrt.org/doc/uci/network
* https://wiki.openwrt.org/doc/uci/dhcp#dhcp_pools
* http://www.networksorcery.com/enp/protocol/bootp/options.htm (dhcp配置)
* https://wiki.openwrt.org/doc/howto/dhcp.dnsmasq(openwrt 看下吧)
<a id="markdown-132-设置静态dns" name="132-设置静态dns"></a>
### 1.3.2. 设置静态dns

```bash
# dnsmasq服务配置

# 还有? /etc/dnsmasq.conf
/var/etc/dnsmasq.conf

resolv-file=/tmp/resolv.conf.auto     # secondary dns (这个文件改了没用)
addn-hosts=/tmp/hosts                 # 额外的解析

# 本地采用的dns服务器
/etc/resolv.conf

# 修改dhcp服务!!
/etc/config/dhcp

修改
option resolvfile '/tmp/resolv.conf.auto' > /tmp/resolv.conf.my

cat >> /tmp/resolv.conf.my << EOF
nameserver 101.6.6.6
EOF

# 还是修改?
# /etc/config/network

# 重启服务
/etc/init.d/dnsmasq  restart

# 启动文件
/etc/profile

rip='/etc/init.d/dnsmasq restart'
cip='vim /tmp/hosts/host.bak'
```

<a id="markdown-2-开启linux代理转发功能" name="2-开启linux代理转发功能"></a>
# 2. 开启Linux代理转发功能
```
vim /etc/sysctl.conf

net.ipv4.ip_forward = 1

# 立即生效
sysctl -p
```

<a id="markdown-3-路由的配置" name="3-路由的配置"></a>
# 3. 路由的配置
选项|说明
-|-
add|表示增加路由信息
del|表示删除路由信息
-net|表示增加一个网络,也就是后面接的是一个网络号地址
-host|表示后面接的为连接到单独主机的路由
netmask|表示后面接的是子网掩码信息,子网掩码可以限制网络的大小
gw|网关IP信息,gateway的简写
dev|指定由哪个网络设备联机出去,后面接网络设备名,如eth0等

<a id="markdown-31-route命令各项说明" name="31-route命令各项说明"></a>
## 3.1. route命令各项说明
```
Destination    Gateway        Genmask        Flags Metric Ref    Use Iface
0.0.0.0        45.32.16.1      0.0.0.0        UG    0      0        0 eth0
45.32.16.0      0.0.0.0        255.255.254.0  U    0      0        0 eth0
169.254.169.254 45.32.16.1      255.255.255.255 UGH  0      0        0 eth0
172.17.0.0      0.0.0.0        255.255.0.0    U    0      0        0 docker0
172.18.0.0      0.0.0.0        255.255.0.0    U    0      0        0 br-ce4c51d4c168
```
* Destination: 表示网络号,也就是network的意思
* Gateway: 连出网关地址,也就是说网络是通过这个IP地址连接出去,如果显示0:0:0:0,则表示该路由直接由本机传送出去,如果有IP显示,表示本条路由必须经过这个IP的转接才能连接出去
* Genmask: 表示子网掩码地址,也就是netmask,Destination和Genmask组合成一个完整的网络
* Flags: 路由标记信息,由下面几种不同标记
 * U (route is up): 表示该路由是启动的
 * H (target is host): 目标路由是一部主机(IP)而非网络
 * R（reinstate route for dynamic routing）：使用动态路由时，恢复路由信息标识。
 * G（use gateway）：表示需要透过外部的主机（gateway）来转接转递数据。
 * M（modified from routing daemon or redirect）：表示路由已经被修改了。
 * D（dynamically installed by daemon or redirect）：已经由服务设定为动态路由。
 * ！（reject route）：这个路由将不会被接受（用来抵挡不安全的网络）
* Metric：需要经过几个网络节点（hops）才能到达路由的目标网络地址。
* Ref：参考到此路由规则的数目。
* Use：有几个转送数据包参考到此路由规则。
* Iface：路由对应的网络设备接口。

<a id="markdown-4-案例" name="4-案例"></a>
# 4. 案例
<a id="markdown-41-公司linux路由器的架设" name="41-公司linux路由器的架设"></a>
## 4.1. 公司Linux路由器的架设
![](http://ouxarji35.bkt.clouddn.com/TIM%E5%9B%BE%E7%89%8720170830160644.png)

Linux作为路由器,必须要有两张网卡,这里假设网卡地址如下:
* ech0: 172.16.135.102
* eth1: 172.16.136.1

Linux网关的配置
```
# 配置eth0
vim /etc/sysconfig/network-scripts/ifcfg-eth0
DEVICE=eth0
BOOTPROTO=static
BROADCAST=172.16.135.255
IPADDR=172.16.135.102
NETMASK=255.255.255.0
NETWORK=172.16.135.0
GATEWAY=172.16.135.254
ONBOOT=yes

# 配置eth1
vim /etc/sysconfig/network-scripts/ifcfg-eth1
DEVICE=eth1
BOOTPROTO=static
BROADCAST=172.16.136.255
IPADDR=172.16.136.1
NETMASK=255.255.255.0
NETWORK=172.16.136.0
ONBOOT=yes

# 开启Linux的转发功能
echo "1" > /proc/sys/net/ipv4/ip_forward

```

DMZ区域服务器设置,Server1为例子
```
vim /etc/sysconfig/network-scripts/ifcfg-eth0
DEVICE=eth0
BOOTPROTO=static
BROADCAST=172.16.136.255
IPADDR=172.16.136.238
NETMASK=255.255.255.0
NETWORK=172.16.136.0
GATEWAY=172.16.136.1
ONBOOT=yes
```

此时Server1服务器已经可以连进互联网了但是由于`Router B没有连接到172.16.136.0/24网段的路由规则`,当数据从互联网传回时将丢失,因此必须添加规则`指定将目标地址为172.16.136.0/24网段的数据包送给172.16.135.254处理`

```
route add -net 172.16.136.0 netmask 255.255.255.0 gw > 172.16.135.254
```

PC1和Server1之间是否互通呢?是的,走向`PC1→Router B→Linux Router A→Server1`,是否有更好的方案呢?是的,在PC1上如下设置
```
route add -net 172.16.136.0 netmask 255.255.255.0 gw > 172.16.135.254
```

提了问:
* http://bbs.hh010.com/forum.php?mod=viewthread&tid=526893&extra=page%3D1
路由通告?

<a id="markdown-5-指令" name="5-指令"></a>
# 5. 指令

* https://www.cyberciti.biz/tips/linux-investigate-sockets-network-connections.html (ss)
* https://www.rationallyparanoid.com/articles/tcpdump.html (tcpdump)
```
# 检查网卡信息
lspci

# 查看网卡详细信息
ethtool eth2

# 查看当前系统加载的模块信息
lsmod

# 加载模块
modprobe 

# 临时开启网卡(永久开启网卡需要修改配置文件)
ifup eth0
# 或
ifconfig eth0 up

# 查看端口监听状态
# -n, --numeric            don't resolve names
# -t tcp
# -u udp
# -l listening
# -p programs
netstat -tulpn

# 查看建立的链接
netstat -tun

# 测试链接
cat < /dev/tcp/45.32.17.217/22

yum install nc -y
nc -v 45.32.17.217 22

# Display Currently Established, Closed, Orphaned and Waiting TCP sockets, enter:
ss -s

# Display All Open Network Ports
ss -l

# Display All TCP Sockets
ss -t -a

# Display All UDP Sockets
ss -u -a

# dns指定服务器
dig @8.8.8.8 qq.com

# dns指定服务器和端口
dig @127.0.0.1 -p 6300 youtube.com

# 显示连接
ss -tna | grep 5001

# 查看内核参数
sysctl -A | grep tcp.*mem

# 查看内核堆积字节数
netstat -tpn | grep '3007\|^[AP]'

# 查看网卡
lspci | grep Ether
```
