

<!-- TOC -->

- [1. 集群的定义](#1-集群的定义)
- [2. 高可用集群软件](#2-高可用集群软件)
    - [2.1. Linux-HA(High-Avalialility Linux)](#21-linux-hahigh-avalialility-linux)
        - [2.1.1. 相关术语](#211-相关术语)
        - [2.1.2. 配置文件及测试方法](#212-配置文件及测试方法)
        - [2.1.3. example](#213-example)
- [3. 负载均衡集群](#3-负载均衡集群)
    - [3.1. LVS(Linux Virtual Server)](#31-lvslinux-virtual-server)
        - [3.1.1. IP负载均衡技术](#311-ip负载均衡技术)
        - [3.1.2. 负载调度算法](#312-负载调度算法)
        - [3.1.3. example](#313-example)
- [4. 科学计算集群HPC](#4-科学计算集群hpc)
- [5. 集群文件系统](#5-集群文件系统)

<!-- /TOC -->


<a id="markdown-1-集群的定义" name="1-集群的定义"></a>
# 1. 集群的定义

集群就是一组协同工作的服务集合,用来提供比单一服务更稳定,更高效,更具扩展性的服务平台.


* 高可用性  
 对于一些实时性很强的应用系统,必须保证服务的24小时不断运行,而由于软件,硬件,网络和人为等各种原因,单一的服务运行环境很难达到这种要求,此时构建一个集群系统是个不错的选择.构建集群的一个最大优点是集群具有高可用性,在服务出现故障时,集群系统可以自动将服务从故障节点切换到另一个备用节点

* 可扩展性  
 随着业务量的增大,现有的集群服务实体不能满足需求时,可以向此集群中动态加入一个或多个服务节点,从而满足应用的需要,增强集群的整体性能,这就是集群的可扩展性

* 负载均衡  
 集群系统最大的特点是可以灵活,有效地分担系统负载,通过集群自身定义的负载分担策略,将客户端的访问分配到下面的各个服务节点.例如,可以定义轮训分配策略,将请求平均分配到各个服务节点,还可以定义最小负载分配策略,当一个请求进来时,集群系统判断哪个服务节点比较清闲,就将此请求分发到这个节点


* 错误恢复  
 当一个任务在一个节点伤害没有完成时,由于某种原因,执行失败,此时,另一个服务节点应该能接着完成此任务,这就是集群提供的错误恢复功能,通过错误的重定向,保证了每个执行任务都能有效完成

* 心跳检测  
 为了能实现负载均衡,提供高可用服务和执行错误恢复,集群系统提供了心跳检测技术,心跳检测是通过心跳线实现的,可以做心跳线设备有RS 232串口线,也可以用独立的一块网卡来跑心跳,还可以是共享磁盘阵列等

 * 漂移IP地址  
 在集群系统中,除了每个服务节点自身的真实IP地址外,还存在一个漂移IP地址,为什么说是漂移IP呢,因为这个IP地址并不固定,例如在两个节点的双机热备中,正常状态下,这个漂移IP位于主节点上,当主节点出现故障后,漂移IP地址自动切换到备用节点上,因此,为了保证服务的不间断性,在集群系统中,对外提供的服务IP一定要是这个漂移IP地址,虽然节点本身的IP也能对外提供服务,但是当此节点失效后,服务切换到了另一个节点,服务IP仍然是故障节点的IP地址,此时,服务就随着中断了

<a id="markdown-2-高可用集群软件" name="2-高可用集群软件"></a>
# 2. 高可用集群软件

常见的HA Cluster

* 双机热备(active/standby)
 备机安装和主服务器一样的应用程序,但是并不启动服务,处于待机状态.当备机监控到主机的某个资源出现故障时,根据预先设定好的策略,首先将IP切换过来,然后将应用程序服务也接管过来,接着就由备机对外提供服务

* 双机互备
 在热备的基础上,两个相互独立的应用在两个机器上同时运行,互为主备,即两台服务器即是主机也是备机.例子:两个应用如果用双机热备技术需要4台机器,如果用双机互备则只需要2台机器,缺点是某个节点故障时,另一个节点就同时运行了两个应用的服务,有可能出现负载过大的情况

* 多机互备
 双机热备的升级,例如:某个集群由8台服务器组成,3台运行Web应用,3台运行mail应用,因而,可以将剩余的一台作为3台Web服务器的备机,另一台作为mail服务器的备机,通过这样的部署,合理充分地利用了服务器资源,同时也保证了系统的高可用性


在Linux下常用的高可用软件有: 
* `Heartbeat HA`
* RedHat RHCS

商业
* ROSE
* `keepalived`


<a id="markdown-21-linux-hahigh-avalialility-linux" name="21-linux-hahigh-avalialility-linux"></a>
## 2.1. Linux-HA(High-Avalialility Linux)
开源项目,目标:通过社区开发者的共同努力,提供一个增量Linux可靠性(reliability),可用性(availability),可服务性(serviceability) (RAS)的解决方案

* http://www.linux-ha.org

拓扑图:  
![](http://ouxarji35.bkt.clouddn.com/snipaste_20171101_111156.png)

<a id="markdown-211-相关术语" name="211-相关术语"></a>
### 2.1.1. 相关术语

* 节点(node)  
 运行Heartbeat进程的一个独立主机,称为节点.在Heartbeat集群中,节点有主次之分,分别称为主节点和备用/备份节点.主节点上一般运行着一个或多个应用服务,而备用节点一般处于监控状态

* 资源(resource)  
 资源是一个节点可以控制的实体,并且当节点发生故障时,这些资源能够被其他节点接管`磁盘分区,文件系统,IP地址,应用程序服务,NFS文件系统,`

* 事件(event)  
 集群可能发生的事情,例如节点发生系统故障,网络连通故障,网卡故障和应用程序故障.这些事件都会导致节点的资源发生转移

* 动作(action)
 事件发生时HA的响应方式,动作是由shell脚本控制的,例如,当某个节点发生故障后,备份节点将通过事件设定好的执行脚本进行服务的关闭和启动,进而接管故障节点的资源.


<a id="markdown-212-配置文件及测试方法" name="212-配置文件及测试方法"></a>
### 2.1.2. 配置文件及测试方法

* /etc/ha.d/ha.cf (配置文件)
* /etc/ha.d/haresources (资源文件)
* /etc/ha.d/authkeys (认证文件)

测试方法:  
* 正常关闭和重启主节点的Heartbeat  
 正常关闭主节点的情况下,主备节点的切换是无缝的,HA对外提供的服务也可以不间断运行
* 在主节点上拔去网线  
 Heartbeat插件ipfail通过ping测试也可以立刻检测到网络连接失败,接着自动释放资源,备用节点的ipfail插件也会检测到主节点出现网络故障,在等待主节点释放资源完毕后,备用节点马上接管了集群资源,从而保证了网络服务不间断持续运行.当主节点网络恢复正常时,由于设置了'auto failback on'选项,集群资源将自动从备用节点切回到主节点
* 在主节点上拔去电源线
* 切断主节点的所有网络连接
* 在主节点上非正常关闭Heartbeat守护进程  
 `killall -9 heartbeat`命令关闭Heartbeat进程时,备份节点会接管主节点资源,但是主节点资源还在使用着,会造成资源冲突.可以通过Linux提供的内核监控模块watchdog解决这个问题,Heartbeat异常终止时或者系统出现故障,watchdog都会自动重启系统,从而释放集群资源,避免了数据冲突的发生


<a id="markdown-213-example" name="213-example"></a>
### 2.1.3. example

![](http://ouxarji35.bkt.clouddn.com/snipaste_20171101_112118.png)

每个节点的/etc/hosts文件要保证一致

![](http://ouxarji35.bkt.clouddn.com/snipaste_20171101_112613.png)

<a id="markdown-3-负载均衡集群" name="3-负载均衡集群"></a>
# 3. 负载均衡集群

英文全称呼`Load Balance Cluster`,简称LB Cluster,与HA Cluster不同的是,在负载均衡集群中,所有的后端节点都处于活动状态,它们都对外提供服务,分摊系统的工作负载

Linux下典型的负载均衡软件有开源`LVS集群`,Oracle的`RAC集群`等,硬件负载均衡器有`F5 Networks`等

<a id="markdown-31-lvslinux-virtual-server" name="31-lvslinux-virtual-server"></a>
## 3.1. LVS(Linux Virtual Server)

LVS是一个中国人创建和开放的开放源码项目,利用LVS可以构建高可用,高可靠的负载均衡集群,因此利用Linux+LVS不但可以假设高性能的负载均衡系统,同时也为企业和个人节省了成本.

* http://www.linuxvirtualserver.org
* http://www.jianshu.com/p/fa937b8e6712 (中文资料,入门了解下)

![](http://ouxarji35.bkt.clouddn.com/snipaste_20171101_144032.png)

* Load Balancer层  
 位于整个集群系统的最前端,由一台或多台负载调度器(Director Server)组成,LVS模块就安装在Director Server上,而Director的主要作用类似于一个路由器.

* Server Array层  
 由一组实际运行应用服务的机器组成,可以是Web/Mail/FTP/DNS/视频中的一个或多个.在实际的应用中,Director Server也可以同时兼Real Server的作用

* Shared Storage层
 为所有Real Server提供共享存储空间和内容一致性的存储区域.一般可以通过NFS网络文件系统共享数据,但是NFS在繁忙的业务系统中,性能不是很好.可以采用Red Hat的`GFS`文件系统,Oracle提供的`OCFS2`文件系统


<a id="markdown-311-ip负载均衡技术" name="311-ip负载均衡技术"></a>
### 3.1.1. IP负载均衡技术
* DNS域名轮流解析
* 基于客户端调度访问
* 基于应用层系统负载的调度方法
* 基于IP地址的调度方法 (`效率最高`)

在`Director Server`上虚拟出一个IP地址,用户必须先通过这个虚拟的IP地址访问服务,这个虚拟IP一般成为`LVS的VIP`,及Virtual IP,访问的请求首先经过VIP到达负载调度器,然后由负载调度器从`Real Server`列表中选取一个服务节点响应用户的请求


IPVS实现负载均衡机制有3种,分别是NAT,TUN和DR
* VS/NAT(Virutal Server via Network Address Translation)
 NAT的方式下,用户请求和响应报文都必须经过Director Server地址重写,当用户请求越来越多时,调度器的处理能力将成为瓶颈
* VS/TUN(Virtual Server via IP Tunneling)
 IP隧道技术.调度器采用IP隧道技术将用户请求转发到某个Real Server,而这个Real Server将直接相应用户的请求,不再经过前段调度器.在TUN模式中,调度器将只处理用户的报文请求,集群系统的吞吐量大大提高
* VS/DR(Virtual Server via Direct Routing)
 直接路由技术实现虚拟服务器,改写请求报文的MAC地址,将请求发送到Real Server,而Real Server将响应直接返回给客户,免去了VS/TUN中的IP隧道开销.`性能最高,最好`,但是必须要求Director Server与Real Server都有一块网卡连在同一物理网段上

<a id="markdown-312-负载调度算法" name="312-负载调度算法"></a>
### 3.1.2. 负载调度算法
IPVS实现了8种负载调度算法,这里只列4种

* 轮叫调度(Round Robin)
 轮叫调度也叫1:1调度,调度器通过轮叫调度算法将外部用户请求按顺序1:1的分配到集群中的每个Real Server中,这种算法平等地对待每一台Real Server,而不管服务器实际上的负载状况和连接状态

* 加权轮叫调度(Weighted Round Robin)
 根据Real Server的不同处理能力来调度访问请求.可以对每台Real Server设置不同的调度权值.同时,调度器还可以自动查询Real Server的负载情况,并动态的调整其权值

* 最少链接调度(Least Connections)
 动态地将网络请求调度到已链接数量最少的服务器上,如果集群系统的真实服务器具有相近的系统性能,那么采用`最小链接`调度算法可以较好地均衡负载

* 加权最少链接调度(Weighted Least Connections)
 每个服务节点可以用相应的权值表示其处理能力,而系统管理员可以动态地设置相应的权值,缺省权值为1,加权最小连接调度在分配新连接请求时尽可能为使用服务节点的已连接数和其权值成正比

<a id="markdown-313-example" name="313-example"></a>
### 3.1.3. example
![](http://ouxarji35.bkt.clouddn.com/snipaste_20171101_212136.png)

测试LVS负载均衡

```bash
echo "This is real server1" /webdata/www/index.html
echo "This is real server2" /web/data/www/index.html
```
接着打开浏览器,访问http://192.168.60.200,然后不断刷新页面就可以看见切换了

<a id="markdown-4-科学计算集群hpc" name="4-科学计算集群hpc"></a>
# 4. 科学计算集群HPC
高性能计算(High Perfermance Computing),简称HPC集群,这类集群致力于提供单个计算机所不能提供的强大的计算能力,包括数值计算和数据处理,并且倾向于追求综合性能

<a id="markdown-5-集群文件系统" name="5-集群文件系统"></a>
# 5. 集群文件系统

我们在Linux下常见的ext2,ext3与reiserfs等都是单一文件系统,这些单一的文件系统只能给单台主机提供数据存储和管理功能,而集群文件系统允许多台主机通过并发的读写同时访问同一个文件,用户无需担心是否会出现读写冲突,因为集群文件系统本身的并发读写机制和锁机制保证了文件读写有序地进行.

以下是开源的集群文件系统.

* GFS(Global File System, 全局文件系统)  
 GFS是一种基于Linux共享磁盘(Shared-disk)的群集文件系统,它支持共享存储设备,使得多台计算机可以同时对这种设备上的文件进行访问
* OCFS2(Oracle Cluster FS)  
 ocfs2是Oracle开发的一个开源集群文件系统,使用OCFS2,用户不但可以在共享磁盘上存储与数据库相关的文件,而且还可以存储与Oracle不相关的其他数据文件
* Lustre文件系统 
 Lustre名字是由Linux和Clusters演化而来,是为了解决海量存储问题而设计的全新文件系统,它是一个开源的,基于对象存储技术的集群并发文件系统,`具有很高的可扩展性,可用性,可靠性和易用性等`,在高性能计算系统中被广泛使用,可支持多达10000个节点,PB级别的存储量,100GB/s的存储速度,同时具有完美的安全性和可管理性
