

<!-- TOC -->

- [1. 说明](#1-说明)
- [2. BIP22](#2-bip22)
- [3. BIP23](#3-bip23)
- [4. BIP145](#4-bip145)
- [5. 分析](#5-分析)
- [6. 参考资料](#6-参考资料)

<!-- /TOC -->

# 1. 说明


```bash
sudo ln -s /mnt/disk1/linux/work  /
cd /work

git clone https://github.com/btccom/btcpool
cd btcpool
git checkout tags/v2.3.2
git branch -d master
git checkout -b master
```

架构包括:

* mysql
* kafka
* zookeeper
* [zeromq]
* [redis]

c++ 库包括

* glog
* gtest
* libev
* boost
* libconf

---
* fmt


依赖:

```bash
sudo ln -s /mnt/disk1/linux/env /

sudo apt-get install build-essential autotools-dev libtool autoconf automake pkg-config cmake \
                   openssl libssl-dev libcurl4-openssl-dev libconfig++-dev \
                   libboost-all-dev libgmp-dev libmysqlclient-dev libzookeeper-mt-dev \
                   libzmq3-dev libgoogle-glog-dev libhiredis-dev zlib1g zlib1g-dev \
                   libprotobuf-dev protobuf-compiler -y

# libevent
cd /env
git clone https://github.com/libevent/libevent.git
cd libevent
./autogen.sh && ./configure --disable-shared && make && sudo make install

# librdkafka
cd /env
wget https://github.com/edenhill/librdkafka/archive/0.9.1.tar.gz && tar zxvf 0.9.1.tar.gz && rm 0.9.1.tar.gz
cd librdkafka-0.9.1
./configure && make && sudo make install

# bitcoin source
cd /env
wget -O bitcoin-0.16.0.tar.gz https://github.com/bitcoin/bitcoin/archive/v0.16.0.tar.gz && tar zxf bitcoin-0.16.0.tar.gz && rm bitcoin-0.16.0.tar.gz

cd /work/btcpool
mkdir -p build && cd build
cmake -DCMAKE_BUILD_TYPE=Debug -DCHAIN_TYPE=BTC -DCHAIN_SRC_ROOT=/env/bitcoin-0.16.0 -DUSE_CUDA=OFF .. 
make -j 12

# 部署到可运行目录
bash ../install/init_folders.sh

# kafka && zookeeper 参考 business/middleware/kafka && zookeeper

# mysql 参考 business/db/mariadb

# bitcoin
bitcoind -rpcuser=ubuntu -rpcpassword=ubuntu -txindex -fallbackfee=0.0002 -zmqpubhashblock=tcp://127.0.0.1:8331 -zmqpubhashtx=tcp://127.0.0.1:8331

# bitocin 第二个节点(多个节点才能getblocktemplate)
bitcoind -datadir=/home/yq/.bitcoin2  -port=10333 -rpcport=10332 -rpcuser=ubuntu -rpcpassword=ubuntu -txindex -fallbackfee=0.0002 

# bitcoin 主题
# /env/kafka/bin/kafka-topics.sh --create --topic RawGbt         --zookeeper localhost:2181 --replication-factor 1 --partitions 1
# /env/kafka/bin/kafka-topics.sh --create --topic StratumJob     --zookeeper localhost:2181 --replication-factor 1 --partitions 1 
# /env/kafka/bin/kafka-topics.sh --create --topic SolvedShare    --zookeeper localhost:2181 --replication-factor 1 --partitions 1 
# /env/kafka/bin/kafka-topics.sh --create --topic ShareLog       --zookeeper localhost:2181 --replication-factor 1 --partitions 1
# /env/kafka/bin/kafka-topics.sh --create --topic CommonEvents   --zookeeper localhost:2181 --replication-factor 1 --partitions 1

# gbtmaker
/work/btcpool/build/run_gbtmaker/gbtmaker -c /work/btcpool/build/run_gbtmaker/gbtmaker.cfg -l stderr

# gwmaker
/work/btcpool/build/run_gwmaker/gwmaker -c /work/btcpool/build/run_gwmaker/gwmaker.cfg -l stderr

# jobmaker
/work/btcpool/build/run_jobmaker/jobmaker -c /work/btcpool/build/run_jobmaker/jobmaker.cfg -l stderr

# blkmaker
/work/btcpool/build/run_blkmaker/blkmaker -c /work/btcpool/build/run_blkmaker/blkmaker.cfg -l stderr

# sharelogger
# /work/btcpool/build/run_sharelogger/sharelogger -c /work/btcpool/build/run_sharelogger/sharelogger.cfg -l stderr

# user list
cd /mnt/disk1/linux/env/btcpooluser && php -S localhost:8000

# sserver
/work/btcpool/build/run_sserver/sserver -c /work/btcpool/build/run_sserver/sserver.cfg -l stderr

# 其他...

# poolwatcher, ~~nmcauxmaker~~

# slparser
/work/btcpool/build/run_slparser/slparser -c /work/btcpool/build/run_slparser/slparser.cfg -l stderr

# statshttpd
/work/btcpool/build/run_statshttpd/statshttpd -c /work/btcpool/build/run_statshttpd/statshttpd.cfg -l stderr

# 挖矿
cd /mnt/disk1/linux/reference/refer/btc
git clone https://github.com/ckolivas/cgminer

sudo apt-get install build-essential autoconf automake libtool pkg-config \
                            libcurl4-openssl-dev libudev-dev libusb-1.0-0-dev \
                            libncurses5-dev

cd cgminer
sh autogen.sh
./configure --enable-cpumining --disable-opencl
make
sudo make install 

# shit 不支持cpu!
cgminer  -o stratum+tcp://127.0.0.1:3333 -u aaa -p x
# cgminer  --url 127.0.0.1:3333 --userpass jack:x

git clone https://github.com/luke-jr/bfgminer 
cd bfgminer
sh autogen.sh
./configure CFLAGS='-g -O0' CXXFLAGS='-g -O0' --enable-cpumining --disable-opencl 
make -j 12
sudo make install 
bfgminer --cpu-threads 1 -o stratum+tcp://127.0.0.1:3333 -u aaa -p x


# 一键结束
pkill -9 gbtmaker;
pkill -9 gwmaker;
pkill -9 jobmaker;
pkill -9 blkmaker;
pkill -9 sserver;

```

# 2. BIP22

不是用于发送散列的简单块头,而是发送整个块结构,并留给矿工(可选地)定制和组装.

getblocktemplate接口需要主节点连接到1+个节点,否则会报错

```bash
mkdir ~/.bitcoin2
bitcoind -datadir=/home/yq/.bitcoin2  -port=10333 -rpcport=10332 -rpcuser=ubuntu -rpcpassword=ubuntu -txindex -fallbackfee=0.0002 
```   

一个案例:
```js
{
    "result": {
        "capabilities": [
            "proposal"
        ],
        "version": 536870912, // 1. nVersion 版本号
        "rules": [
            "testdummy", // 普通
            "csv",       // 相对事件锁
            "segwit"     // 隔离见证
        ],
        "vbavailable": {}, 
        "vbrequired": 0,
        "previousblockhash": "7963bceae928318363eb6961176fb228dd80a9de6d5d07b2d9a4a737cb765503",  // 2. 上一个区块的hash
        "transactions": [ // 3. 通过所有的交易的hashid 可以得到merkle hash root
            {
                "data": "02000000016e3be18169b34c767ed476d7626aba897811f4d4618d516a917d3da217b070ec000000006a47304402205815e7bdc329ebe478a00c09012fc0f93ac1273de2dacaaf10fd075140ac7a1c02202fbaeaffc0a828c8bc8b45d7e7b732a450cde2d93287b10cefbb17dbe9d3c74a0121024f0cbc9c14dfd5f7a567b137880ae6426f7b95c638dcc36908db206764daf957feffffff0114e3052a010000001976a91403f49ec8e10f87a42c0c1fcbf013435c27bca16288ac4d040000",
                "txid": "7ee11d7780f5786a3a2d4909654a099160c7610f8f600abd209de5c4f54b287e",
                "hash": "7ee11d7780f5786a3a2d4909654a099160c7610f8f600abd209de5c4f54b287e",
                "depends": [],
                "fee": 3820,
                "sigops": 4,
                "weight": 764
            }
        ],
        "coinbaseaux": {
            "flags": ""
        },
        "coinbasevalue": 5000003820, // extra: coinbase reward
        "longpollid": "7963bceae928318363eb6961176fb228dd80a9de6d5d07b2d9a4a737cb7655031105", // 上一区块的hash 经过了多少轮
        "target": "7fffff0000000000000000000000000000000000000000000000000000000000",
        "mintime": 1555571272, // 4. nTime
        "mutable": [
            "time",
            "transactions",
            "prevblock"
        ],
        "noncerange": "00000000ffffffff", // 6. nNonce
        "sigoplimit": 80000,
        "sizelimit": 4000000,
        "weightlimit": 4000000,
        "curtime": 1555571522,
        "bits": "207fffff", // 5. nBits
        "height": 1102
    },
    "error": null,
    "id": "curltest"
}
```

stratum.notify
```js
{  
   "id":null,
   "method":"mining.notify",
   "params":[  
      "2", // job id
      "4d846d0303eca79e7a1a31503166cc3c64045d50f616111c35d318f47149ed9c", // 前面的区块的hash
      "02000000010000000000000000000000000000000000000000000000000000000000000000ffffffff2c02f50304b64fc15c726567696f6e312f50726f6a65637420425443506f6f6c2f", // Generation transaction (part 1)
      "ffffffff0200f2052a01000000000000000000000000266a24aa21a9ede2f61c3f71d1defd3fa999dfa36953755c690689799962b48bebd836974e8cf900000000", // Generation transaction (part 2)
      [ 
        // List of merkle branches.
      ],
      "20000000", // version
      "207fffff", // nBits
      "5cc14fb5", // nTime
      false // Clean Jobs
   ]
}
```

# 3. BIP23


# 4. BIP145


# 5. 分析

```bash
# bfgminer, 默认submit需要计算hash的次数
(1.0 / (2 ** 224 - 1)) * 2 ** 256 / 1000 / 1000 / 1000 = 4G 次
(1.0 / (2 ** 224 - 1)) * 2 ** 256 / 1000 / 1000 / 0.5 = 8589 sec
(1.0 / (2 ** 224 - 1)) * 2 ** 256 / 1000 / 1000 / 0.5 = 2.4 hour (fuck)

# btcpool 全网算力, 7.091 EH/s.   蚂蚁s17 53 TH/s. 大约有 132台 s17?
# 如果按照默认的submit需要计算hash的次数来说的话:
# 一台矿机: 13250/s 太多了吧, 肯定不采用这个难度来分配的
# 全网: 1750000/s 卧槽!


(1.0 / (2 ** 232 - 1)) * 2 ** 256 / 1000 / 1000 / 0.5 # = 33, 0.5MB hash/s的速度 大概找33s能找到结果

其实bfgminer默认的挖矿难度有两个设置,思路是按照256bit取多少范围来思考:

1. unlikely((hash32[7] == 0)),  => 224
2. work->nonce_diff = 1.0 => 232

我改成了: 

unlikely((hash32[7] & 0xffffff00) == 0) => 232

测试用:
if (unlikely((hash32[7] & 0xffff0000) == 0)) => 240
{
    *nonce = htole32(n);
    *last_nonce = n;
    return true;
}

(1.0 / (2 ** 240 - 1)) * 2 ** 256 / 1000 / 1000 / 0.5 # = 0.1, 0.5MB hash/s的速度 大概找0.1s能找到结果

cuckoo cycle:
# 1.0/6  hash速度, 改为m单位: 1.0/6/1000/1000 
(1.0 / (2 ** 248 - 1)) * 2 ** 256 / 1000 / 1000 / (1.0/6/1000/1000)

即使要求256bit的头部8bit为0,也要算1536秒才能算出结果. 而pkc的最低难度要求是
0x7fffff0000000000000000000000000000000000000000000000000000000000

```

# 6. 参考资料

* https://github.com/btccom/btcpool
* https://pool.btc.com/ (网站)
* https://github.com/btccom/btcpool/blob/master/docs/INSTALL-BTCPool.md (编译文档)
* https://github.com/bitcoin/bips/blob/master/bip-0022.mediawiki (getblocktemplate)
* https://blog.csdn.net/itcastcpp/article/details/80380262 (瞎看看呗)
* https://github.com/ckolivas/cgminer (asic && fpga挖矿)
* https://github.com/luke-jr/bfgminer (老的cgminer支持cpu)

---

* https://github.com/MPOS/php-mpos (早期的矿池被使用的最多,特别是山寨币)
* https://github.com/zone117x/node-open-mining-portal (支持多币种挖矿)
* https://github.com/sigwo/powerpool (支持混合挖矿)
