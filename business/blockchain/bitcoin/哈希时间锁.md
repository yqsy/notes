

<!-- TOC -->

- [1. 说明](#1-说明)
- [2. 原子交换](#2-原子交换)
- [3. 参考资料](#3-参考资料)

<!-- /TOC -->


# 1. 说明

参考上文nSequence双向支付通道,我们已经有了一种基于两者之间的可撤销的支付通道,也就是在链上把币打到双重签名脚本之后,使用可撤销支付通道不断在链下更新两者之间的利益关系,而只有最终的状态才可以被提交到区块链上,因为中间的状态都被"撤销"了,一旦同步到区块链,会被对方使用时间去解锁而损失所有的币.

这个通道解决了链上转账速度慢的问题,10分钟出一个块,即使使用了隔离见证技术,也只能将整体容量扩充到1.x个MB.而一个交易就要占200+字节的大小, 1000000 / 200 / 60 / 10 = 8 , 所以也就意味着1秒钟只能转10笔交易以下.如果全世界所有的交易都在链上进行,那么区块链一定会不堪重负. 使用链下签名,支付通道的技术可以减少转账的次数 -- 只需要链上抵押一次,结束链下状态同步后链上同步一次. 几乎可以说是从根源处解决问题--链上交易慢,那么我们不走链上,在链下交易完了然后同步到链上.

但是仅仅只有通道只能完成两两之间的转账,因为状态同步是需要先在链上把币抵押到多重签名脚本里面的. A <-> B 打通了转账的通道, B <-> C 打通了转账的通道, 按照逻辑来说, 两两分别打通那么岂不是 A <-> C, A与C也可以完成转账了? 并不行, 还是上面提到的原因原因: 状态同步是需要现在链上把币抵押到多重签名脚本里面的, A  与 C 并没有多重签名脚本. 那有没有办法可以通过A与B的通道,B与C的通道,将A的币转给C,C的币转给A,(在链下) .  答案是有的. 聪明的国外人想出来了哈希时间锁的办法.


A <-> B <-> C

1. A和B建立了双向支付通道, B和C建立了双向支付通道
2. A要向C转1000个satoshis
3. C生成随机数, 并把随机数的hash给A
4. A支付给B 1000个satoshis,解锁条件是B的私钥签名和随机数hash对应的随机数
5. B支付给C 1000个satoshis,解锁条件是C的私钥签名和随机数hash对应的随机数
6. C想要得到这个1000个satoshis,必须出示随机数. 
7. 当C出示了随机数,那么B就可以得知随机数并拿走A的转账
8. 完成了币从 A -> B -> C的流通


# 2. 原子交换

A 生成随机数x

A 创建交易 TX1: "支付w BTC给 B" 如果 H(x) 的x被得知和被B签名 或者 同时被A和B签名

A 创建交易 TX2: "从TX1支付w BTC给 A" 上链后锁定48小时, A已经签名了

A 发送TX2 给B

B 签名TX2 返回给A

1) A 提交TX1 到网络

B 创建 TX3: "支付v alt-coins 给 A" 如果 H(x)被得知和被A签名 或者同时被A和B签名

B 创建 TX4: "支付v alt-coins 给 B" 时上链后锁定24小时,A已经签名了

B 发送TX4 给A

A 签名了TX4 返回给B

2) B 提交 TX3 到网络

3) A 花费TX3, 展示了 x

4) B 花费TX1 使用x


# 3. 参考资料

* https://en.bitcoin.it/wiki/Hash_Time_Locked_Contracts
