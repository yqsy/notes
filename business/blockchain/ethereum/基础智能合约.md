<!-- TOC -->

- [1. truffle发布合约到本地开发网络(9545)](#1-truffle发布合约到本地开发网络9545)
- [2. truffle发布合约到ganache-cli(8545)](#2-truffle发布合约到ganache-cli8545)

<!-- /TOC -->

<a id="markdown-1-truffle发布合约到本地开发网络9545" name="1-truffle发布合约到本地开发网络9545"></a>
# 1. truffle发布合约到本地开发网络(9545)

```bash
# 别被@5.0.5坑了: https://github.com/trufflesuite/truffle/issues/1727
# npm install truffle@5.0.0 -g

npm install truffle

cd /mnt/disk1/linux/reference/test
mkdir turffletest
cd turffletest
truffle init

# 创建合约 & 部署js & 单元测试
truffle create contract SimpleStorage
truffle create migration SimpleStorage
truffle create test SimpleStorage

# 相应的命令：
# Compile:        truffle compile
# Migrate:        truffle migrate
# Test contracts: truffle test
```

合约复制到`./contracts/SimpleStorage.sol`:
```bash
cat > /mnt/disk1/linux/reference/test/turffletest/contracts/SimpleStorage.sol << EOF
pragma solidity >=0.4.21 <0.6.0;

contract SimpleStorage {
    address private deployer;
    uint private storedData;

    constructor() public {
        deployer = msg.sender;
    }

    function set(uint n) public {
        if(msg.sender == deployer)
            storedData = n;
    }

    function get() public view returns (uint) {
        return storedData;
    }
}
EOF
```

部署脚本复制到`./migrations/xxxxxx_simple_storage.js`
```bash
MIGRATE_JS=`ls /mnt/disk1/linux/reference/test/turffletest/migrations/ | grep simple_storage`

cat > /mnt/disk1/linux/reference/test/turffletest/migrations/$MIGRATE_JS << EOF
var SimpleStorage = artifacts.require("./SimpleStorage.sol");

module.exports = function(deployer) {
  deployer.deploy(SimpleStorage);
};
EOF
```

编译 & 部署
```bash
# 部署到开发环境  (truffle的默认网络,监听9545)
truffle develop

# 编译 & 部署
compile
migrate

# 获取实例
var simpleStorage
SimpleStorage.deployed().then(instance => simpleStorage = instance)

# 查看
simpleStorage.get().then(bn => bn.toNumber())

# 修改
simpleStorage.set(10)

# 再查看
simpleStorage.get().then(bn => bn.toNumber())
```

<a id="markdown-2-truffle发布合约到ganache-cli8545" name="2-truffle发布合约到ganache-cli8545"></a>
# 2. truffle发布合约到ganache-cli(8545)

```bash
npm install -g ganache-cli

# 开启测试rpc网络
ganache-cli

cat >> /mnt/disk1/linux/reference/test/turffletest/truffle-config.js << EOF
module.exports = {
  networks: {
    development: {
     host: "127.0.0.1",     // Localhost (default: none)
     port: 8545,            // Standard Ethereum port (default: none)
     network_id: "*",       // Any network (default: none)
    },
  }
}
EOF

# 打开控制台  (ganache-cli的网络,监听8545)
truffle console --network development

# 编译 & 部署
compile
migrate
```
