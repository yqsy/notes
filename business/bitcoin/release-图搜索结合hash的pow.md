---
title: 图搜索结合hash的pow
date: 2018-02-01 13:29:12
categories: [business, bitcoin]
---

<!-- TOC -->

- [1. 说明](#1-说明)
- [2. 参考资料](#2-参考资料)

<!-- /TOC -->


<a id="markdown-1-说明" name="1-说明"></a>
# 1. 说明

比特币的proof of work的原理是不断变化头部的字节,以找到hash头部数据的hash值小于nBits生成的nTarget.其本质是一个概率游戏,通过不断缩小答案的范围值来提高难度(答案范围值越小,落在答案范围内的概率越小).为了争夺coinbase奖励,asic矿机出现了,其T级别的哈系速度使得M级别的GPU,CPU望而生畏惧.asic矿机的本质原理是,增加`每秒尝试次数`,以达到尝试到目标答案范围内的解值.

将图搜索结合hash可以将`每秒尝试次数受限制于内存延迟(memory latency)`.在我本机 cpu: i7-7700, 内存: 16g, 进行cuckoo-cycle 基于图论的搜索算法时(edgebits=19,proofsize=42),求解一道题目需要`6s`.暂时我们不在难度调整中加入cuckoo-cycle的参数调整,因为我们的目的就是为了限制在hash proof中的每秒尝试次数.(但如果后期ASIC矿机设计出来了,而由于cuckoo-cycle的难度比重相较于sha256算法显得比重过小的话,还是会产生ASIC的军备竞赛问题,所以这一问题要等到对于cuckoo-cycle有很深刻的把握的时候才能去设计难度控制,使得难度比重都在cuckoo-cycle当中,或许要硬分叉来解决) (但是我想我的机器寻找cycle的速度为1/6 graph/s, 专用的矿机不会出现像sha256的T级别的吧, 只要维持在K级别,那都是可以竞争的,理应是的)

下面是基于1/6 graph/s 之上,加上sha256的难度控制使的出块速度稳定在60s的推理:


```bash
# 难度为1时,出块时间60s 所需要的hash速度
1 * 2 ** 32  / 60 = 70M hashes / s

# 搭配cuckoo-cycle来计算hash时
# 我本机的速度是1/6graph/s,也就是1/6hash/s(忽略sha256本身的计算时间)
# 设计算x次hash才能找到一次解

(1 / 6) / (70*10**6) = x / 2 ** 32
x = (1 / 6.0) / (70*10**6) * 2 ** 32 = 10

# 也就是答案范围在2*256占据了1/10,一般需要10次搜索才能得到解
# 这里暂时不考虑sha256的正态分布问题,也许大概率都分布在这10%的范围内
# 以至于初期出块速度没有受到sha256的限制

# 设target为offset
2 ** 256 * (1 / offset) = 10
offset = 2 ** 256 / 10

# print("%x" % (2 ** 256 / 10))
offset = 0x1999999999999999999999999999999999999999999999999999999999999999

# 对应的nBits
nBits = 0x20199999
```

<a id="markdown-2-参考资料" name="2-参考资料"></a>
# 2. 参考资料

* https://github.com/tromp/cuckoo
